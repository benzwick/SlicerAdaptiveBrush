# ADR-009: Living Documentation Strategy

## Status

Accepted

## Context

Documentation often becomes stale because:

1. Code changes but docs don't get updated
2. Screenshots become outdated after UI changes
3. Manual documentation is tedious and error-prone
4. No verification that docs match actual behavior

We need a documentation system that:

- Updates automatically when code changes
- Generates screenshots from actual tests
- Stays in sync with test coverage
- Requires minimal manual maintenance

## Decision

Implement **living documentation** where tests drive documentation:

### Core Principles

1. **Tests are the source of truth** - if it's not tested, it's not documented
2. **Screenshots are generated, not captured** - tests produce screenshots automatically
3. **Docs are built from code** - documentation derives from docstrings and test files
4. **CI keeps everything in sync** - documentation regenerates on each commit

### Documentation Pipeline

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   Tests     │────▶│ Screenshots  │────▶│    Docs     │
│  (pytest)   │     │  (captured)  │     │  (website)  │
└─────────────┘     └──────────────┘     └─────────────┘
       │                                        │
       └────────────────────────────────────────┘
                    CI Pipeline
```

### Screenshot Generation

Tests capture screenshots at key moments:

```python
def test_paint_bone_tissue(slicer_app):
    """Test painting with bone preset."""
    # Setup
    load_sample_data("CTChest")
    select_effect("Adaptive Brush")
    apply_preset("Bone")

    # Action
    paint_at_location(100, 150)

    # Capture for docs
    capture_screenshot("bone_preset_result.png")

    # Verify
    assert segment_volume() > 1000
```

### Documentation Structure

```
docs/
  index.md              # Auto-generated from README
  user-guide/
    getting-started.md  # From test_basic_workflow.py
    algorithms.md       # From test_algorithms.py
    presets.md          # From test_presets.py
  screenshots/          # Generated by tests
    bone_preset_result.png
    watershed_example.png
  api/                  # Generated from docstrings
    SegmentEditorEffect.md
```

### Website Generation

Use **Sphinx** with GitHub Pages (Sphinx chosen for better Python API documentation support via autodoc):

```yaml
# .github/workflows/docs.yml
jobs:
  generate-screenshots:
    steps:
      - name: Run documentation tests
        run: Slicer --python-script scripts/run_tests.py --exit docs

  build-docs:
    needs: generate-screenshots
    steps:
      - name: Extract screenshots
        run: python scripts/extract_screenshots_for_docs.py

      - name: Build Sphinx docs
        run: cd docs && make html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
```

### Documentation Tagging

Screenshots are tagged for documentation purposes:

```python
def test_watershed_algorithm(ctx: TestContext):
    """Test watershed algorithm with documentation screenshots."""
    ctx.screenshot("Watershed result",
                   doc_tags=["algorithm", "watershed", "result"])
```

Tags allow filtering screenshots for specific documentation pages.

### Claude's Role

Claude assists by:

1. **Writing documentation** that matches test behavior
2. **Generating test cases** from user-recorded sessions
3. **Updating docs** when tests change
4. **Ensuring consistency** between code, tests, and docs

## Consequences

### Positive

- Documentation is always current
- Screenshots reflect actual UI
- Tests verify documented behavior
- Reduced manual documentation effort
- Single source of truth

### Negative

- Initial setup is complex
- CI pipeline is slower (screenshot generation)
- Requires discipline to write tests that produce good docs
- Screenshot generation needs headless display (Xvfb)

## Alternatives Considered

### Traditional manual documentation

**Rejected**: Becomes stale, high maintenance burden.

### Wiki-based documentation

**Rejected**: Disconnected from code, no automated updates.

### README-only documentation

**Rejected**: Insufficient for complex features, no screenshots.

## Implementation Notes

### Screenshot Capture Utility

```python
def capture_screenshot(filename: str, view: str = "Red"):
    """Capture screenshot from Slicer view."""
    widget = slicer.app.layoutManager().sliceWidget(view)
    pixmap = qt.QPixmap.grabWidget(widget)
    pixmap.save(f"docs/screenshots/{filename}")
```

### Sphinx Configuration

```python
# docs/source/conf.py
extensions = [
    "myst_parser",           # Markdown support
    "sphinx_rtd_theme",      # ReadTheDocs theme
    "sphinx.ext.autodoc",    # API from docstrings
    "sphinx.ext.napoleon",   # Google-style docstrings
    "sphinx.ext.viewcode",   # Source code links
]

# MyST parser for Markdown
myst_enable_extensions = [
    "colon_fence",
    "deflist",
    "tasklist",
]
```

### Test-to-Documentation Pipeline

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Documentation  │───▶│   Screenshots    │───▶│  Extract for    │
│  Test Suite     │    │   (doc_tags)     │    │  Docs Pages     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                                              │
         │                                              ▼
         │                                     ┌─────────────────┐
         │                                     │  Algorithm      │
         │                                     │  Docs Generator │
         │                                     └─────────────────┘
         │                                              │
         ▼                                              ▼
┌─────────────────┐                           ┌─────────────────┐
│  API Docstrings │──────────────────────────▶│  Sphinx Build   │
└─────────────────┘                           └─────────────────┘
                                                       │
                                                       ▼
                                              ┌─────────────────┐
                                              │  GitHub Pages   │
                                              └─────────────────┘
```

## References

- [Sphinx Documentation](https://www.sphinx-doc.org/)
- [MyST Parser](https://myst-parser.readthedocs.io/)
- [GitHub Pages](https://pages.github.com/)
- [Living Documentation (Gojko Adzic)](https://gojko.net/books/specification-by-example/)
- [Slicer Screenshot Capture](https://slicer.readthedocs.io/en/latest/developer_guide/script_repository.html#capture-a-screenshot)
