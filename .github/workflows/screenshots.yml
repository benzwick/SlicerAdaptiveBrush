name: Screenshots

on:
  # Run on push to main when relevant files change
  push:
    branches: [main]
    paths:
      - 'SegmentEditorAdaptiveBrush/**'
      - 'scripts/capture_screenshots.py'
      - '.github/workflows/screenshots.yml'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

env:
  SLICER_VERSION: "5.10.0"
  SLICER_REVISION: "34045"

jobs:
  capture:
    name: Capture Screenshots
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Slicer
        id: cache-slicer
        uses: actions/cache@v4
        with:
          path: ~/Slicer
          key: slicer-${{ env.SLICER_VERSION }}-${{ env.SLICER_REVISION }}-linux

      - name: Download Slicer
        if: steps.cache-slicer.outputs.cache-hit != 'true'
        run: |
          # Download Slicer preview release
          SLICER_URL="https://download.slicer.org/download?os=linux&stability=release"
          echo "Downloading Slicer from: $SLICER_URL"

          mkdir -p ~/Slicer
          cd ~/Slicer

          # Download and extract
          curl -L -o slicer.tar.gz "$SLICER_URL"
          tar -xzf slicer.tar.gz --strip-components=1
          rm slicer.tar.gz

          echo "Slicer downloaded to ~/Slicer"
          ls -la ~/Slicer/

      - name: Install display dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            libxcb-xinerama0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            libxkbcommon-x11-0 \
            libegl1 \
            libgl1-mesa-dri \
            libgl1-mesa-glx \
            libopengl0 \
            libglx0 \
            x11-utils

      - name: Install extension in Slicer
        run: |
          # Create Slicer settings to add module path
          mkdir -p ~/.config/NA-MIC

          # Add module paths
          SETTINGS_FILE=~/.config/NA-MIC/Slicer.ini
          MODULE_PATH="$(pwd)/SegmentEditorAdaptiveBrush"
          REVIEWER_PATH="$(pwd)/SegmentEditorAdaptiveBrushReviewer"
          TESTER_PATH="$(pwd)/SegmentEditorAdaptiveBrushTester"

          cat > "$SETTINGS_FILE" << EOF
          [Modules]
          AdditionalPaths=$MODULE_PATH, $REVIEWER_PATH, $TESTER_PATH
          EOF

          echo "Slicer settings:"
          cat "$SETTINGS_FILE"

      - name: Capture screenshots
        run: |
          # Start Xvfb
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2

          # Verify display
          echo "Display: $DISPLAY"

          # Find Slicer executable
          SLICER_BIN=$(find ~/Slicer -name "Slicer" -type f -executable | head -1)
          echo "Slicer binary: $SLICER_BIN"

          # Run screenshot capture
          # Use timeout to prevent hanging
          timeout 300 "$SLICER_BIN" \
            --python-script scripts/capture_screenshots.py \
            --exit \
            || true

          # Check if screenshots were created
          echo "Screenshots directory:"
          ls -la Screenshots/ || echo "No screenshots directory"

      - name: Verify screenshots
        id: verify
        run: |
          if [ -f "Screenshots/main-ui.png" ]; then
            echo "screenshots_created=true" >> $GITHUB_OUTPUT
            echo "Screenshots captured successfully:"
            ls -la Screenshots/
          else
            echo "screenshots_created=false" >> $GITHUB_OUTPUT
            echo "Warning: Screenshots not created"
          fi

      - name: Upload screenshots as artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: Screenshots/
          retention-days: 30

      - name: Commit screenshots
        if: steps.verify.outputs.screenshots_created == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if there are changes to commit
          if git diff --quiet Screenshots/; then
            echo "No changes to screenshots"
          else
            git add Screenshots/
            git commit -m "chore: Update auto-generated screenshots

          Generated by GitHub Actions workflow.
          Slicer version: ${{ env.SLICER_VERSION }}
          "
            git push
            echo "Screenshots committed and pushed"
          fi
